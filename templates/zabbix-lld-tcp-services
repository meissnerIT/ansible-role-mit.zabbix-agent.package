#!/usr/bin/env python3
#
# Managed by ansible ({{ ansible_role_name }})
# DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
#
# Reports all configured services.
#
# {{ etc_prefix }}/etc/zabbix/mit-zabbix-lld-tcp-services.conf:
#
# - IP (optional)
# - PORT
# - DISPLAY_NAME (set to 'BY_SERVICE_DESCRIPTION' for getting the name via service / systemctl)
# - TAG
#
# markus.meissner@meissner.IT
#
# - 2024-07-16: Initial release
# - 2025-02-27: Added etc prefix for conf file, added IP

import csv
import json
import os

import zabbix_lld

data = list()


def is_port_number(v):
    try:
        int(v)
    except ValueError:
        return False
    return True


def append(data, ip, port, display_name, ip_port_dn, tag):
    data.append(
        {
            "{{ '{#IP}' }}": ip,
            "{{ '{#PORT}' }}": port,
            "{{ '{#DISPLAY_NAME}' }}": display_name,
            "{{ '{#IP_PORT_DN}' }}": ip_port_dn,
            "{{ '{#TAG}' }}": tag,
        }
    )


conffile = "{{ etc_prefix }}/etc/zabbix/mit-zabbix-lld-tcp-services.conf"
if os.path.exists(conffile):
    with open(conffile) as csvfile:
        csvreader = csv.reader(csvfile)
        for row in csvreader:
            if len(row) > 0 and not row[0].startswith("#"):
                if is_port_number(row[0]):
                    append(
                        data,
                        "",
                        row[0],
                        zabbix_lld.get_service_name(row[1]),
                        "tcp/" + row[0],
                        row[2] if len(row) > 2 else "",
                    )
                else:
                    append(
                        data,
                        row[0],
                        row[1],
                        zabbix_lld.get_service_name(row[2]),
                        row[0] + ":" + row[1],
                        row[3] if len(row) > 3 else "",
                    )

# Output all
print(json.dumps({"data": data}, indent=4))
