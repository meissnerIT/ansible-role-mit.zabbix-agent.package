---

# Either use "static: no" or use variables in the include file, otherwise the include will always be used (statically included)
#- name: "Including Debian 7 (Wheezy)"
#  include: "Debian_7.yml"
#  static: no
#  when: (ansible_distribution == "Debian" and ansible_distribution_major_version == "7")

# We use ansible_lsb.id instead of ansible_distribution as this adds support for 
# UCS (Univention Corporate Server) which reports ansible_distribution=Debian and
# ansible_lsb.id=Univention

- include_tasks: "{{ ansible_system }}-{{ ansible_lsb.id }}_{{ ansible_lsb.major_release }}.yml"
  when: ansible_lsb is defined and ansible_lsb.id is defined

- include_tasks: "{{ ansible_system }}-{{ ansible_distribution }}_{{ ansible_distribution_major_version }}-{{ ansible_machine }}.yml"
  when: ansible_lsb is not defined or ansible_lsb.id is not defined

# Every OS specific playbook must set_fact zabbix_agent_conf_dir
- name: Copy local-userparameter_*
  copy:
    src: "{{ item }}"
    dest: "{{ zabbix_agent_conf_dir }}"
  with_items:
    - local-userparameter_local-vfs-dir-count.conf
    - local-userparameter_local-vfs-file-owner.conf
    - local-userparameter_local-web-page-get.conf
    - local-userparameter_system-sw-packages-version.conf
    - local-userparameter_systemd.conf
  notify: Restart zabbix-agent

# e.g. files/etc/zabbix_agentd.conf.d/local-my.host.conf
- name: Copy local-{{ inventory_hostname }}.conf
  copy:
    src: "{{ item }}"
    dest: "{{ zabbix_agent_conf_dir }}/local.conf"
  with_first_found:
    - files:
      - "etc/zabbix_agentd.conf.d/local-{{ inventory_hostname }}.conf"
      skip: yes
  notify: Restart zabbix-agent

- name: Remove deprecated local-userparameter_*
  ansible.builtin.file:
    path: "{{ zabbix_agent_conf_dir }}/local-userparameter_systemd-timesyncd-timedatectl.conf"
    state: absent
  notify: Restart zabbix-agent

# https://wiki.debian.org/SystemGroups
- name: Add user zabbix to group adm
  user:
    name: zabbix
    groups: adm
    append: yes
  notify: Restart zabbix-agent

